<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPAS Dashboard</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-color: #0d1117;
      --card-bg: #161b22;
      --text-color: #c9d1d9;
      --accent: #00ffff;
      --secondary: #58a6ff;
      --table-border: #30363d;
      --gauge-track: #333;
    }
    body { background: var(--bg-color); color: var(--text-color); font-family: 'Poppins', Arial, sans-serif; margin:0; padding:0; transition: 0.6s; }
    header { background: var(--card-bg); padding: 15px 30px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 12px var(--accent); position: sticky; top:0; z-index:100; }
    h1 { color: var(--accent); margin:0; font-size:22px; }
    .logout { color: var(--accent); text-decoration:none; border:1px solid var(--accent); padding:8px 12px; border-radius:6px; background:transparent; transition:0.3s; font-size:14px; }
    .logout:hover { background: var(--accent); color: var(--bg-color); box-shadow:0 0 15px var(--accent); }
    .container { padding:30px; max-width:1200px; margin:0 auto; }
    .card { background: var(--card-bg); border-radius:12px; box-shadow:0 0 20px var(--accent)30; padding:25px; margin-bottom:25px; transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card:hover { transform: scale(1.02); box-shadow:0 0 30px var(--accent)60; }
    h2 { color: var(--accent); margin-bottom:10px; }
    .chart { display:flex; justify-content:center; align-items:center; margin-top:15px; }
    img { border-radius:10px; box-shadow:0 0 25px var(--accent)40; max-width:100%; height:auto; }
    .role-info { font-size:18px; color: var(--secondary); }
    .info-box { margin-top:15px; background: var(--bg-color); border:1px solid var(--accent)60; border-radius:8px; padding:18px; font-size:16px; }
    .info-box strong { color: var(--accent); }
    .table-wrapper { overflow-x:auto; margin-top:10px; }
    table { width:100%; border-collapse:collapse; color: var(--text-color); margin-top:10px; }
    th, td { border-bottom:1px solid var(--table-border); padding:10px; text-align:left; }
    th { color: var(--accent); background: var(--card-bg); cursor:pointer; transition:0.2s; }
    th:hover { background: var(--accent)20; }
    tr:hover { background-color: var(--accent)10; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:15px; }
    .search-bar input { background: var(--bg-color); border:1px solid var(--accent)60; color: var(--text-color); padding:8px 12px; border-radius:6px; font-size:14px; width:250px; transition:0.3s; }
    .search-bar input:focus { border-color: var(--accent); box-shadow:0 0 10px var(--accent)80; outline:none; }
    .download-btn { background: var(--accent); color: var(--bg-color); border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-size:14px; transition:0.3s; }
    .download-btn:hover { box-shadow:0 0 15px var(--accent); transform: scale(1.05); }
    .delete-btn { background-color:#ff4444; border:none; color:white; padding:6px 12px; border-radius:6px; cursor:pointer; transition:0.3s; font-size:13px; }
    .delete-btn:hover { background-color:#ff6666; box-shadow:0 0 10px #ff4444; }
    .gauge-container { display:flex; justify-content:center; gap:60px; flex-wrap:wrap; margin-top:25px; }
    .gauge { position:relative; width:140px; height:140px; border-radius:50%; background:conic-gradient(var(--accent) var(--value, 0%), var(--gauge-track) 0%); display:flex; justify-content:center; align-items:center; box-shadow:0 0 25px var(--accent)50; transition:background 1s ease; }
    .gauge::before { content:attr(data-label); position:absolute; bottom:-30px; font-size:14px; color:var(--accent); text-transform:uppercase; letter-spacing:1px; }
    .gauge span { font-size:22px; font-weight:bold; color:var(--accent); text-shadow:0 0 8px var(--accent); }
    @media (max-width:768px){.search-bar input{width:100%;}}
    .confirm-modal { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:9999; }
    .confirm-box { background:rgba(15,25,35,0.9); border:2px solid var(--accent); border-radius:12px; padding:30px; text-align:center; color:var(--accent); box-shadow:0 0 25px var(--accent); backdrop-filter:blur(10px); max-width:400px; }
    .confirm-buttons { margin-top:20px; display:flex; justify-content:center; gap:20px; }
    .confirm-btn, .cancel-btn { border:none; padding:8px 18px; border-radius:8px; font-weight:bold; cursor:pointer; transition:0.3s; }
    .confirm-btn { background:#00ff99; color:#000; }
    .confirm-btn:hover { box-shadow:0 0 15px #00ff99; }
    .cancel-btn { background:#ff4d4d; color:#fff; }
    .cancel-btn:hover { box-shadow:0 0 15px #ff4d4d; }
    #flashPopup { position:fixed; top:25px; right:25px; z-index:99999; display:flex; flex-direction:column; gap:10px; }
    .flash-msg { background: rgba(0,255,255,0.12); border:1px solid var(--accent); color: var(--accent); padding:12px 22px; border-radius:12px; box-shadow:0 0 18px var(--accent); font-weight:500; animation:fadeInOut 4s ease forwards; backdrop-filter:blur(6px); }
    .flash-msg.success { border-color:#00ff99; color:#00ff99; box-shadow:0 0 18px #00ff99; }
    .flash-msg.danger { border-color:#ff4d4d; color:#ff4d4d; box-shadow:0 0 18px #ff4d4d; }
    .flash-msg.warning { border-color:#ffaa00; color:#ffaa00; box-shadow:0 0 18px #ffaa00; }
    @keyframes fadeInOut{0%{opacity:0; transform:translateY(-20px);} 10%,90%{opacity:1; transform:translateY(0);} 100%{opacity:0; transform:translateY(-20px);}}
    .filter-select { background: var(--bg-color); border:1px solid var(--accent)60; color: var(--text-color); padding:6px 12px; border-radius:6px; font-size:14px; margin-right:10px; margin-bottom:10px; }
    .charts-row { display:flex; gap:40px; flex-wrap:wrap; margin-top:20px; }
    .chart-card { flex:1; min-width:300px; background: var(--card-bg); border-radius:12px; padding:20px; box-shadow:0 0 20px var(--accent)30; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
    .stat-card { background: var(--card-bg); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 0 15px var(--accent)30; }
    .stat-value { font-size: 28px; font-weight: bold; color: var(--accent); margin: 10px 0; }
    .stat-label { font-size: 14px; color: var(--secondary); text-transform: uppercase; letter-spacing: 1px; }
    .performance-list { margin-top: 20px; }
    .performance-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--table-border); }
    .performance-item:last-child { border-bottom: none; }
    .no-data { text-align: center; color: var(--secondary); padding: 40px; font-style: italic; }
    .filter-active { background: var(--accent)20; border-color: var(--accent); }
    .reset-filters { background: transparent; border: 1px solid var(--secondary); color: var(--secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-left: 10px; }
    .reset-filters:hover { background: var(--secondary); color: var(--bg-color); }
    .filter-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px; }
    .teacher-info-box { color: var(--accent); padding: 10px 15px; background: var(--bg-color); border: 1px solid var(--accent); border-radius: 6px; margin-bottom: 10px; }
    .performance-status { display: inline-block; padding: 10px 20px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--accent); margin-top: 15px; }
    .compact-performance { max-height: 300px; overflow-y: auto; border: 1px solid var(--table-border); border-radius: 8px; padding: 10px; }
    .compact-row { display: grid; grid-template-columns: 1fr auto auto auto; gap: 10px; padding: 10px; border-bottom: 1px solid var(--table-border); align-items: center; }
    .compact-header { font-weight: bold; border-bottom: 2px solid var(--accent); }
    
    /* NEW STYLES FOR IMPROVED STUDENT SECTION */
    .student-dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .student-main-content {
      grid-column: 1 / -1;
    }
    
    .student-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .student-chart-container {
      height: 300px;
      min-height: 300px;
    }
    
    .compact-student-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 1024px) {
      .student-dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Upload section specific styles */
    .upload-section-teacher {
      border-left: 4px solid #4caf50;
    }
    
    .upload-section-admin {
      border-left: 4px solid #2196f3;
    }

    /* NEW STYLES FOR HISTORICAL DATA */
    .progress-comparison {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    
    .progress-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: var(--bg-color);
      border-radius: 8px;
      border: 1px solid var(--accent)40;
    }
    
    .progress-dates {
      display: flex;
      gap: 20px;
      font-size: 14px;
      color: var(--secondary);
    }
    
    .progress-value {
      font-weight: bold;
      font-size: 18px;
      color: var(--accent);
    }
    
    .progress-improvement {
      font-size: 14px;
      padding: 4px 10px;
      border-radius: 12px;
      background: var(--card-bg);
    }
    
    .progress-improvement.positive {
      color: #00ff99;
      border: 1px solid #00ff99;
    }
    
    .progress-improvement.negative {
      color: #ff4d4d;
      border: 1px solid #ff4d4d;
    }
    
    .progress-improvement.neutral {
      color: var(--secondary);
      border: 1px solid var(--secondary);
    }
    
    .historical-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .toggle-btn {
      background: var(--bg-color);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }
    
    .toggle-btn.active {
      background: var(--accent);
      color: var(--bg-color);
    }
    
    .toggle-btn:hover:not(.active) {
      background: var(--accent)20;
    }
  </style>
</head>
<body>
  <header>
    <h1>Student Performance Analysis System</h1>
    <a href="{{ url_for('logout') }}" class="logout">Logout</a>
  </header>

  <div class="container">
    <div class="card">
      <h2>Welcome, {{ username }}</h2>
      <p class="role-info">Role: {{ role }}</p>
    </div>

    <!-- CHANGED: Upload button only for Teacher, not Admin -->
    {% if role == 'Teacher' %}
      <div class="card upload-section-teacher">
        <h2>üìÅ Upload Student Data / Reports</h2>
        <a href="{{ url_for('upload') }}" class="download-btn">Go to Upload Page</a>
        <p style="margin-top: 10px; font-size: 14px; color: var(--secondary);">
          You can upload data for students in your department and college only.
        </p>
      </div>
    {% endif %}

    {% if role in ['Teacher','Admin'] %}
      <!-- Filters for Admin / Teacher analytics -->
      <div class="card">
        <div class="top-bar">
          <h2>Analytics Filters</h2>
          <button class="reset-filters" onclick="resetFilters()">üîÑ Reset Filters</button>
        </div>
        
        <div class="filter-row">
          {% if role=='Admin' %}
          <select id="collegeFilter" class="filter-select" onchange="applyFilters()"> 
            <option value="">All Colleges</option>
            {% for c in colleges %}<option value="{{c}}">{{c}}</option>{% endfor %}
          </select>
          
          <select id="departmentFilter" class="filter-select" onchange="applyFilters()">
            <option value="">All Departments</option>
            {% for d in departments %}<option value="{{d}}">{{d}}</option>{% endfor %}
          </select>
          {% else %}
          <!-- Teacher sees fixed department and college info -->
          <div class="teacher-info-box">
            <strong>Department:</strong> {{ departments[0] if departments else 'N/A' }} | 
            <strong>College:</strong> {{ colleges[0] if colleges else 'N/A' }}
          </div>
          {% endif %}
          
          <select id="semesterFilter" class="filter-select" onchange="applyFilters()">
            <option value="">All Semesters</option>
            {% for s in semesters %}<option value="{{s}}">Semester {{s}}</option>{% endfor %}
          </select>
        </div>
        
        <div style="margin-top: 10px; font-size: 14px; color: var(--secondary);">
          <span id="filterStatus">
            {% if role == 'Teacher' %}
            Viewing students from {{ departments[0] if departments else 'N/A' }}, {{ colleges[0] if colleges else 'N/A' }}
            {% else %}
            Showing all data
            {% endif %}
          </span>
        </div>
      </div>

      <!-- Students Table -->
      <div class="card">
        <div class="top-bar">
          <h2>üë• Students Overview</h2>
          <div>
            <button class="download-btn" onclick="downloadTableCSV('studentsTable','students_report.csv')">‚¨áÔ∏è CSV</button>
            <button class="download-btn" onclick="downloadTablePDF('studentsTable','Students Report')">üìÑ PDF</button>
          </div>
        </div>
        <div class="search-bar">
          <input type="text" class="table-search" placeholder="üîç Search Students..." data-table="studentsTable" />
        </div>
        <div class="table-wrapper">
          <table id="studentsTable" class="sortable">
            <thead>
              <tr>
                <th data-sort="string">Enrollment</th>
                <th data-sort="string">Name</th>
                <th data-sort="string">Email</th>
                <th data-sort="string">Department</th>
                <th data-sort="string">College</th>
                <th data-sort="string">Semester</th>
                <th data-sort="number">Avg Marks</th>
                <th data-sort="number">Avg Attendance</th>
                <th data-sort="number">Tests</th>
                <th data-sort="string">Status</th>
                <!-- CHANGED: Action column for both Admin and Teacher -->
                {% if role in ['Admin', 'Teacher'] %}
                <th>Action</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% if students %}
                {% for s in students %}
                <tr data-department="{{ s.department }}" data-college="{{ s.college }}" data-semester="{{ s.semester }}">
                  <td>{{ s.enrollment }}</td>
                  <td>{{ s.name }}</td>
                  <td>{{ s.email or 'N/A' }}</td>
                  <td>{{ s.department or 'N/A' }}</td>
                  <td>{{ s.college or 'N/A' }}</td>
                  <td>{{ s.semester or 'N/A' }}</td>
                  <td>{{ s.avg_marks }}</td>
                  <td>{{ s.avg_attendance }}</td>
                  <td>{{ s.total_tests }}</td>
                  <td>
                    <span style="color: {{ s.status_color }};">{{ s.performance_status }}</span>
                  </td>
                  <!-- CHANGED: Delete button for both Admin and Teacher -->
                  {% if role in ['Admin', 'Teacher'] %}
                  <td>
                    <form action="{{ url_for('delete_student', student_id=s.enrollment) }}" method="POST">
                      <button type="button" class="delete-btn" onclick="showConfirmModal(this)">üóëÔ∏è Delete</button>
                    </form>
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="{% if role in ['Admin', 'Teacher'] %}11{% else %}10{% endif %}" style="text-align: center; color: var(--secondary);">No students found</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="card">
        <h2>üìä Performance Statistics</h2>
        <div class="stats-grid" id="statsContainer">
          <!-- Stats will be updated dynamically -->
        </div>
      </div>

      <!-- Advanced Analytics Charts -->
      <div class="card" id="analyticsSection">
        <h2>üìà Advanced Analytics</h2>
        <div id="analyticsCharts">
          <!-- Charts will be loaded here dynamically -->
        </div>
      </div>

    {% endif %}

    {% if role=='Student' %}
      <!-- IMPROVED: Better layout for student section with historical data -->
      <div class="card student-main-content">
        <h2>üìà Your Performance Overview</h2>
        {% if student_info %}
          <div class="compact-student-info">
            <div class="info-box">
              <p><strong>Name:</strong> {{ student_info.name }}</p>
              <p><strong>Enrollment:</strong> {{ student_info.enrollment }}</p>
            </div>
            <div class="info-box">
              <p><strong>Email:</strong> {{ student_info.email }}</p>
              <p><strong>Department:</strong> {{ student_info.department }}</p>
            </div>
            <div class="info-box">
              <p><strong>College:</strong> {{ student_info.college }}</p>
              <p><strong>Semester:</strong> {{ student_info.semester or 'N/A' }}</p>
            </div>
          </div>
          
          <div class="student-dashboard-grid">
            <!-- Left Column: Gauges and Status -->
            <div class="student-sidebar">
              <!-- Performance Gauges -->
              <div class="card">
                <h3>üìä Key Metrics</h3>
                <div class="gauge-container">
                  <div class="gauge" data-label="Marks" style="--value: {{ student_info.avg_marks }}%;">
                    <span>{{ student_info.avg_marks }}%</span>
                  </div>
                  <div class="gauge" data-label="Attendance" style="--value: {{ student_info.avg_attendance }}%;">
                    <span>{{ student_info.avg_attendance }}%</span>
                  </div>
                  <div class="gauge" data-label="Tests" style="--value: {{ (student_info.total_tests / 10 * 100) if student_info.total_tests < 10 else 100 }}%;">
                    <span>{{ student_info.total_tests }}</span>
                  </div>
                </div>
                
                <!-- Performance Status -->
                <div style="text-align: center; margin-top: 20px;">
                  <div class="performance-status">
                    <strong>Performance:</strong> 
                    <span style="color: {{ student_info.status_color }};">{{ student_info.performance_status }}</span><br>
                    <strong>Attendance:</strong> 
                    <span style="color: {{ student_info.attendance_color }};">{{ student_info.attendance_status }}</span>
                  </div>
                </div>
              </div>

              <!-- Performance Summary Cards -->
              <div class="card">
                <h3>üéØ Progress Tracking</h3>
                
                <!-- Progress Comparison -->
                <div class="progress-comparison">
                  <div class="progress-item">
                    <div>
                      <div><strong>Overall Progress</strong></div>
                      <div class="progress-dates">
                        <span>Started: {{ student_info.first_test_date or 'N/A' }}</span>
                        <span>Latest: {{ student_info.last_test_date or 'N/A' }}</span>
                      </div>
                    </div>
                    <div class="progress-value">{{ student_info.overall_progress }}%</div>
                  </div>
                  
                  <div class="progress-item">
                    <div>
                      <div><strong>Performance Trend</strong></div>
                      <div class="progress-dates">
                        <span>First Test: {{ student_info.first_test_score or 'N/A' }}%</span>
                        <span>Latest: {{ student_info.last_test_score or 'N/A' }}%</span>
                      </div>
                    </div>
                    <div>
                      <div class="progress-value">{{ student_info.trend_difference }}%</div>
                      <div class="progress-improvement {{ student_info.trend_class }}">
                        {{ student_info.trend_direction }}
                      </div>
                    </div>
                  </div>
                  
                  <div class="progress-item">
                    <div>
                      <div><strong>Attendance Trend</strong></div>
                      <div class="progress-dates">
                        <span>First: {{ student_info.first_attendance or 'N/A' }}%</span>
                        <span>Latest: {{ student_info.last_attendance or 'N/A' }}%</span>
                      </div>
                    </div>
                    <div>
                      <div class="progress-value">{{ student_info.attendance_trend }}%</div>
                      <div class="progress-improvement {{ student_info.attendance_trend_class }}">
                        {{ student_info.attendance_trend_direction }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column: Chart -->
            <div class="card" style="grid-column: span 1;">
              <div class="top-bar">
                <h3>üìà Performance Trend</h3>
                <div class="historical-toggle">
                  <button class="toggle-btn active" onclick="toggleChartView('all')">All Data</button>
                  <button class="toggle-btn" onclick="toggleChartView('recent')">Recent (6 Tests)</button>
                  <button class="toggle-btn" onclick="toggleChartView('semester')">This Semester</button>
                </div>
              </div>
              <div class="student-chart-container">
                {% if student_chart_data and student_chart_data.labels and student_chart_data.labels|length > 0 %}
                  <canvas id="studentTrendChart"></canvas>
                {% else %}
                  <div class="no-data">
                    <p>üìù No performance history available yet.</p>
                    <p>Complete some tests to see your progress analytics.</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Compact Performance History - Below the main grid -->
          {% if student_chart_data and student_chart_data.labels and student_chart_data.labels|length > 0 %}
          <div class="card" style="margin-top: 20px;">
            <h3>üìã Test History</h3>
            <div class="compact-performance">
              <div class="compact-row compact-header">
                <span>Test</span>
                <span>Date</span>
                <span>Marks</span>
                <span>Predicted</span>
                <span>Attendance</span>
                <span>Progress</span>
              </div>
              {% for i in range(student_chart_data.labels|length) %}
              <div class="compact-row">
                <span><strong>{{ student_chart_data.labels[i] }}</strong></span>
                <span>{{ student_chart_data.dates[i] if student_chart_data.dates and student_chart_data.dates[i] else 'N/A' }}</span>
                <span style="color: var(--accent);">{{ student_chart_data.actual_marks[i] }}%</span>
                {% if student_chart_data.predicted_marks and student_chart_data.predicted_marks[i] %}
                <span style="color: #58a6ff;">{{ student_chart_data.predicted_marks[i] }}%</span>
                {% else %}
                <span style="color: var(--secondary);">-</span>
                {% endif %}
                <span style="color: #00ff99;">{{ student_chart_data.attendance[i] if student_chart_data.attendance and student_chart_data.attendance[i] else 'N/A' }}%</span>
                <span>
                  {% if i > 0 %}
                    {% set prev_mark = student_chart_data.actual_marks[i-1] %}
                    {% set current_mark = student_chart_data.actual_marks[i] %}
                    {% set diff = current_mark - prev_mark %}
                    <span class="progress-improvement {{ 'positive' if diff > 0 else 'negative' if diff < 0 else 'neutral' }}">
                      {{ '+' if diff > 0 else '' }}{{ diff }}%
                    </span>
                  {% else %}
                    <span class="progress-improvement neutral">-</span>
                  {% endif %}
                </span>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        {% else %}
          <div class="no-data">
            <p>‚ùå No student information available. Please contact your administrator.</p>
          </div>
        {% endif %}
      </div>
      
      <!-- Additional Student Insights -->
      {% if student_info and student_info.total_tests > 0 %}
      <div class="card">
        <h2>üéØ Performance Insights</h2>
        <div class="info-box">
          {% if student_info.avg_marks >= 75 %}
          <p>‚úÖ <strong>Excellent Performance:</strong> You're performing exceptionally well! Keep up the great work.</p>
          {% elif student_info.avg_marks >= 60 %}
          <p>üëç <strong>Good Performance:</strong> You're doing well. Focus on consistent improvement.</p>
          {% elif student_info.avg_marks >= 40 %}
          <p>‚ö†Ô∏è <strong>Average Performance:</strong> There's room for improvement. Consider seeking additional help.</p>
          {% else %}
          <p>‚ùå <strong>Needs Improvement:</strong> Please consult with your teachers for guidance and support.</p>
          {% endif %}
          
          {% if student_info.avg_attendance >= 80 %}
          <p>‚úÖ <strong>Excellent Attendance:</strong> Your attendance record is excellent.</p>
          {% elif student_info.avg_attendance >= 60 %}
          <p>‚ö†Ô∏è <strong>Average Attendance:</strong> Try to improve your attendance for better learning.</p>
          {% else %}
          <p>‚ùå <strong>Poor Attendance:</strong> Regular attendance is crucial for academic success.</p>
          {% endif %}
          
          <p><strong>Total Tests Completed:</strong> {{ student_info.total_tests }}</p>
          
          <!-- Historical Progress Summary -->
          {% if student_info.total_tests > 1 %}
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--table-border);">
            <h4 style="color: var(--accent); margin-bottom: 10px;">üìà Historical Progress</h4>
            <p>Your performance has {{ student_info.trend_direction.lower() }} by {{ student_info.trend_difference|abs }}% since your first test.</p>
            <p>You've completed tests spanning {{ student_info.testing_period }}.</p>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- Confirm Modal -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-box">
      <h3>‚ö†Ô∏è Confirm Delete</h3>
      <p>Are you sure you want to delete this student?<br>This action cannot be undone.</p>
      <div class="confirm-buttons">
        <button class="confirm-btn" id="confirmYes">Yes, Delete</button>
        <button class="cancel-btn" id="confirmNo">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Flash Messages -->
  <div id="flashPopup">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash-msg {{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <script>
    // ---------------- Global Variables ----------------
    const studentsData = {{ students_json | tojson | safe if students_json is defined else '[]' }};
    const allChartData = {{ chart_data | tojson | safe if chart_data is defined else '{}' }};
    let currentCharts = {};
    let filteredStudentsData = [...studentsData];
    let currentChartView = 'all';

    // ---------------- Confirm Modal ----------------
    let formToSubmit = null;
    const modal = document.getElementById("confirmModal");
    const confirmYes = document.getElementById("confirmYes");
    const confirmNo = document.getElementById("confirmNo");
    
    function showConfirmModal(btn){ 
        formToSubmit = btn.closest("form"); 
        if (modal) modal.style.display="flex"; 
    }
    
    if (confirmYes && confirmNo) {
        confirmYes.onclick = () => { 
            if (modal) modal.style.display="none"; 
            if(formToSubmit) formToSubmit.submit(); 
        }
        
        confirmNo.onclick = () => { 
            if (modal) modal.style.display="none"; 
        }
    }

    // ---------------- Table Search ----------------
    function initializeTableSearch() {
      document.querySelectorAll(".table-search").forEach(input=>{
        input.addEventListener("keyup", ()=>{
          const tableId = input.getAttribute("data-table");
          const filter = input.value.toLowerCase();
          const rows = document.querySelectorAll(`#${tableId} tbody tr`);
          if (rows.length === 0) return;
          
          rows.forEach(row=>{
            const showByFilter = row.innerText.toLowerCase().includes(filter);
            const showByDept = row.style.display !== 'none';
            row.style.display = (showByFilter && showByDept) ? "" : "none";
          });
        });
      });
    }

    // ---------------- Flash messages timeout ----------------
    setTimeout(()=>{ 
        const popup = document.getElementById('flashPopup'); 
        if(popup) popup.remove(); 
    }, 4500);

    // ---------------- CSV/PDF Download Functions ----------------
    function downloadTableCSV(tableId, filename){
      const table = document.getElementById(tableId);
      if (!table) return;
      
      let csv = [];
      // Only include visible rows
      const visibleRows = Array.from(table.rows).filter(row => 
        row.style.display !== 'none' && row.cells.length > 0
      );
      
      for(let row of visibleRows){
        let cols = [];
        for(let cell of row.cells){
          cols.push(cell.innerText.replace(/,/g,''));
        }
        csv.push(cols.join(','));
      }
      const csvFile = new Blob([csv.join('\n')], {type:'text/csv'});
      const link = document.createElement('a');
      link.download = filename;
      link.href = URL.createObjectURL(csvFile);
      link.click();
    }

    function downloadTablePDF(tableId, title){
      alert('PDF download feature placeholder - would generate PDF report');
    }

    // ---------------- Filter Functions ----------------
    function applyFilters() {
      const deptFilter = document.getElementById('departmentFilter')?.value || '';
      const colFilter = document.getElementById('collegeFilter')?.value || '';
      const semesterFilter = document.getElementById('semesterFilter')?.value || '';
      
      // Update filter status
      updateFilterStatus(deptFilter, colFilter, semesterFilter);
      
      // Filter student data
      filteredStudentsData = studentsData.filter(student => {
        const deptMatch = !deptFilter || student.department === deptFilter;
        const colMatch = !colFilter || student.college === colFilter;
        const semesterMatch = !semesterFilter || student.semester == semesterFilter;
        return deptMatch && colMatch && semesterMatch;
      });
      
      // Update table
      updateTableFilter(deptFilter, colFilter, semesterFilter);
      
      // Update statistics
      updateStatistics();
      
      // Update charts
      updateAllCharts();
    }

    function resetFilters() {
      const deptFilter = document.getElementById('departmentFilter');
      const colFilter = document.getElementById('collegeFilter');
      const semesterFilter = document.getElementById('semesterFilter');
      
      if (deptFilter) deptFilter.value = '';
      if (colFilter) colFilter.value = '';
      if (semesterFilter) semesterFilter.value = '';
      
      applyFilters();
    }

    function updateFilterStatus(deptFilter, colFilter, semesterFilter) {
      const statusElement = document.getElementById('filterStatus');
      if (!statusElement) return;
      
      const filters = [];
      
      if (deptFilter) filters.push(`${deptFilter} department`);
      if (colFilter) filters.push(`${colFilter} college`);
      if (semesterFilter) filters.push(`Semester ${semesterFilter}`);
      
      let statusText = 'Showing all data';
      if (filters.length > 0) {
        statusText = `Showing: ${filters.join(', ')}`;
      }
      
      statusElement.textContent = statusText;
    }

    function updateTableFilter(deptFilter, colFilter, semesterFilter) {
      const rows = document.querySelectorAll("#studentsTable tbody tr");
      if (rows.length === 0) return;
      
      rows.forEach(row => {
        let show = true;
        if (deptFilter) { 
          if (row.dataset.department !== deptFilter) show = false; 
        }
        if (colFilter) { 
          if (row.dataset.college !== colFilter) show = false; 
        }
        if (semesterFilter) { 
          if (row.dataset.semester != semesterFilter) show = false; 
        }
        row.style.display = show ? "" : "none";
      });
    }

    function updateStatistics() {
      const statsContainer = document.getElementById('statsContainer');
      if (!statsContainer) return;
      
      const data = filteredStudentsData;
      
      const totalStudents = data.length;
      const avgMarks = data.length > 0 ? 
        (data.reduce((sum, student) => sum + student.avg_marks, 0) / data.length).toFixed(2) : 0;
      const avgAttendance = data.length > 0 ? 
        (data.reduce((sum, student) => sum + student.avg_attendance, 0) / data.length).toFixed(2) : 0;
      
      // Get performance distribution
      const excellent = data.filter(s => s.avg_marks >= 75).length;
      const good = data.filter(s => s.avg_marks >= 60 && s.avg_marks < 75).length;
      const average = data.filter(s => s.avg_marks >= 40 && s.avg_marks < 60).length;
      const needsImprovement = data.filter(s => s.avg_marks < 40).length;
      
      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${totalStudents}</div>
          <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${avgMarks}%</div>
          <div class="stat-label">Avg Marks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${avgAttendance}%</div>
          <div class="stat-label">Avg Attendance</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${excellent}</div>
          <div class="stat-label">Excellent</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${good}</div>
          <div class="stat-label">Good</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${average}</div>
          <div class="stat-label">Average</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${needsImprovement}</div>
          <div class="stat-label">Needs Help</div>
        </div>
      `;
    }

    // ---------------- Chart Functions ----------------
    function updateAllCharts() {
      const data = filteredStudentsData;
      
      // Show/hide analytics section based on data
      const analyticsSection = document.getElementById('analyticsSection');
      const analyticsCharts = document.getElementById('analyticsCharts');
      
      if (!analyticsCharts) return;
      
      if (data.length === 0) {
        analyticsCharts.innerHTML = '<div class="no-data">No data available for current filters</div>';
        return;
      }
      
      // Destroy existing charts
      Object.values(currentCharts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
          chart.destroy();
        }
      });
      currentCharts = {};
      
      // Generate new charts based on filtered data
      analyticsCharts.innerHTML = `
        <div class="charts-row">
          <div class="chart-card">
            <h3>üè´ Department Performance</h3>
            <canvas id="deptComparisonChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>üìà Marks Distribution</h3>
            <canvas id="marksDistributionChart"></canvas>
          </div>
        </div>
        <div class="charts-row">
          <div class="chart-card">
            <h3>üéØ Performance Overview</h3>
            <canvas id="performanceChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>üìä Attendance vs Marks</h3>
            <canvas id="attendanceCorrelationChart"></canvas>
          </div>
        </div>
        <div class="charts-row">
          <div class="chart-card">
            <h3>üìö Semester Performance</h3>
            <canvas id="semesterPerformanceChart"></canvas>
          </div>
        </div>
        ${'{{ role }}' === 'Admin' ? `
        <div class="charts-row">
          <div class="chart-card">
            <h3>üèõÔ∏è College Performance</h3>
            <canvas id="collegePerformanceChart"></canvas>
          </div>
        </div>
        ` : ''}
      `;
      
      // Create charts
      createDepartmentComparisonChart(data);
      createMarksDistributionChart(data);
      createPerformanceChart(data);
      createAttendanceCorrelationChart(data);
      createSemesterPerformanceChart(data);
      if ('{{ role }}' === 'Admin') {
        createCollegePerformanceChart(data);
      }
    }

    function createDepartmentComparisonChart(data) {
      const ctx = document.getElementById('deptComparisonChart');
      if (!ctx) return;
      
      // Group by department
      const deptData = {};
      data.forEach(student => {
        const dept = student.department || 'Unknown';
        if (!deptData[dept]) {
          deptData[dept] = { marks: [], attendance: [] };
        }
        deptData[dept].marks.push(student.avg_marks);
        deptData[dept].attendance.push(student.avg_attendance);
      });
      
      const labels = Object.keys(deptData);
      const avgMarks = labels.map(dept => 
        deptData[dept].marks.reduce((a, b) => a + b, 0) / deptData[dept].marks.length
      );
      const avgAttendance = labels.map(dept => 
        deptData[dept].attendance.reduce((a, b) => a + b, 0) / deptData[dept].attendance.length
      );
      
      currentCharts.deptComparison = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Average Marks',
              data: avgMarks,
              backgroundColor: 'rgba(0, 255, 255, 0.6)',
              borderColor: 'rgba(0, 255, 255, 1)',
              borderWidth: 1
            },
            {
              label: 'Average Attendance',
              data: avgAttendance,
              backgroundColor: 'rgba(88, 166, 255, 0.6)',
              borderColor: 'rgba(88, 166, 255, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: '#00ffff' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { color: '#00ffff' }
            },
            x: {
              ticks: { color: '#00ffff' }
            }
          }
        }
      });
    }

    function createMarksDistributionChart(data) {
      const ctx = document.getElementById('marksDistributionChart');
      if (!ctx) return;
      
      const marks = data.map(student => student.avg_marks);
      const bins = [0, 40, 50, 60, 70, 80, 90, 100];
      const counts = new Array(bins.length - 1).fill(0);
      
      marks.forEach(mark => {
        for (let i = 0; i < bins.length - 1; i++) {
          if (mark >= bins[i] && mark < bins[i + 1]) {
            counts[i]++;
            break;
          }
        }
        if (mark === 100) counts[counts.length - 1]++;
      });
      
      const labels = bins.slice(0, -1).map((bin, i) => `${bin}-${bins[i + 1]}`);
      
      currentCharts.marksDistribution = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Number of Students',
            data: counts,
            backgroundColor: [
              'rgba(255, 99, 132, 0.6)',
              'rgba(255, 159, 64, 0.6)',
              'rgba(255, 205, 86, 0.6)',
              'rgba(75, 192, 192, 0.6)',
              'rgba(54, 162, 235, 0.6)',
              'rgba(153, 102, 255, 0.6)'
            ],
            borderColor: [
              'rgb(255, 99, 132)',
              'rgb(255, 159, 64)',
              'rgb(255, 205, 86)',
              'rgb(75, 192, 192)',
              'rgb(54, 162, 235)',
              'rgb(153, 102, 255)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: '#00ffff' }
            }
          },
          scales: {
            y: {
              ticks: { color: '#00ffff' }
            },
            x: {
              ticks: { color: '#00ffff' }
            }
          }
        }
      });
    }

    function createPerformanceChart(data) {
      const ctx = document.getElementById('performanceChart');
      if (!ctx) return;
      
      // Show top 10 students by marks
      const topStudents = [...data]
        .sort((a, b) => b.avg_marks - a.avg_marks)
        .slice(0, 10);
      
      currentCharts.performance = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: topStudents.map(s => s.name),
          datasets: [
            {
              label: 'Marks %',
              data: topStudents.map(s => s.avg_marks),
              backgroundColor: 'rgba(0, 255, 255, 0.6)',
              borderColor: 'rgba(0, 255, 255, 1)',
              borderWidth: 1
            },
            {
              label: 'Attendance %',
              data: topStudents.map(s => s.avg_attendance),
              backgroundColor: 'rgba(88, 166, 255, 0.6)',
              borderColor: 'rgba(88, 166, 255, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: '#00ffff' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { color: '#00ffff' }
            },
            x: {
              ticks: { 
                color: '#00ffff',
                maxTicksLimit: 10
              }
            }
          }
        }
      });
    }

    function createAttendanceCorrelationChart(data) {
      const ctx = document.getElementById('attendanceCorrelationChart');
      if (!ctx) return;
      
      currentCharts.attendanceCorrelation = new Chart(ctx.getContext('2d'), {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Students',
            data: data.map(student => ({
              x: student.avg_attendance,
              y: student.avg_marks
            })),
            backgroundColor: 'rgba(0, 255, 255, 0.6)',
            borderColor: 'rgba(0, 255, 255, 1)',
            borderWidth: 1,
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: '#00ffff' }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const student = data[context.dataIndex];
                  return `${student.name}: ${context.parsed.x}% attendance, ${context.parsed.y}% marks`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Marks (%)',
                color: '#00ffff'
              },
              ticks: { color: '#00ffff' }
            },
            x: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Attendance (%)',
                color: '#00ffff'
              },
              ticks: { color: '#00ffff' }
            }
          }
        }
      });
    }

    function createSemesterPerformanceChart(data) {
      const ctx = document.getElementById('semesterPerformanceChart');
      if (!ctx) return;
      
      // Group by semester
      const semesterData = {};
      data.forEach(student => {
        const semester = student.semester || 'Unknown';
        if (!semesterData[semester]) {
          semesterData[semester] = { marks: [], attendance: [], count: 0 };
        }
        semesterData[semester].marks.push(student.avg_marks);
        semesterData[semester].attendance.push(student.avg_attendance);
        semesterData[semester].count++;
      });
      
      const labels = Object.keys(semesterData).sort();
      const avgMarks = labels.map(sem => 
        semesterData[sem].marks.reduce((a, b) => a + b, 0) / semesterData[sem].marks.length
      );
      const avgAttendance = labels.map(sem => 
        semesterData[sem].attendance.reduce((a, b) => a + b, 0) / semesterData[sem].attendance.length
      );
      const studentCounts = labels.map(sem => semesterData[sem].count);
      
      currentCharts.semesterPerformance = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels.map(sem => `Semester ${sem}`),
          datasets: [
            {
              label: 'Average Marks',
              data: avgMarks,
              backgroundColor: 'rgba(0, 255, 255, 0.6)',
              borderColor: 'rgba(0, 255, 255, 1)',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: 'Average Attendance',
              data: avgAttendance,
              backgroundColor: 'rgba(88, 166, 255, 0.6)',
              borderColor: 'rgba(88, 166, 255, 1)',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: 'Number of Students',
              data: studentCounts,
              backgroundColor: 'rgba(255, 205, 86, 0.6)',
              borderColor: 'rgba(255, 205, 86, 1)',
              borderWidth: 1,
              type: 'line',
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: '#00ffff' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Percentage (%)',
                color: '#00ffff'
              },
              ticks: { color: '#00ffff' }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'Number of Students',
                color: '#ffcd56'
              },
              ticks: { color: '#ffcd56' },
              grid: {
                drawOnChartArea: false
              }
            },
            x: {
              ticks: { color: '#00ffff' }
            }
          }
        }
      });
    }

    function createCollegePerformanceChart(data) {
      const ctx = document.getElementById('collegePerformanceChart');
      if (!ctx) return;
      
      // Group by college
      const collegeData = {};
      data.forEach(student => {
        const college = student.college || 'Unknown';
        if (!collegeData[college]) {
          collegeData[college] = [];
        }
        collegeData[college].push(student.avg_marks);
      });
      
      const labels = Object.keys(collegeData);
      const avgMarks = labels.map(college => 
        collegeData[college].reduce((a, b) => a + b, 0) / collegeData[college].length
      );
      
      currentCharts.collegePerformance = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Average Marks',
              data: avgMarks,
              backgroundColor: 'rgba(0, 255, 255, 0.6)',
              borderColor: 'rgba(0, 255, 255, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: '#00ffff' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { color: '#00ffff' }
            },
            x: {
              ticks: { color: '#00ffff' }
            }
          }
        }
      });
    }

    // ---------------- Student Trend Chart with Historical Data ----------------
    function initializeStudentTrendChart() {
      {% if role == 'Student' and student_info %}
      // Safely get student chart data with comprehensive fallbacks
      const studentTrendData = {{ student_chart_json | tojson | safe if student_chart_json is defined else '{"labels": [], "actual_marks": [], "predicted_marks": []}' }};
      const trendCtx = document.getElementById('studentTrendChart');
      
      if (!trendCtx) return;
      
      // Validate data before creating chart
      const hasValidData = studentTrendData && 
                          studentTrendData.labels && 
                          Array.isArray(studentTrendData.labels) && 
                          studentTrendData.labels.length > 0 &&
                          studentTrendData.actual_marks && 
                          Array.isArray(studentTrendData.actual_marks) && 
                          studentTrendData.actual_marks.length > 0;
      
      if (hasValidData) {
        try {
          // Check if Chart is available
          if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            trendCtx.parentElement.innerHTML = '<p style="color: #ff4444; text-align: center;">Chart library not loaded. Please refresh the page.</p>';
            return;
          }
          
          // Create the chart with all historical data initially
          createStudentTrendChart(trendCtx, studentTrendData, 'all');
          
        } catch (error) {
          console.error('Error creating student trend chart:', error);
          trendCtx.innerHTML = '<p style="color: #ff4444; text-align: center; padding: 20px;">Error loading performance chart</p>';
        }
      } else {
        // Show message if no data available
        trendCtx.innerHTML = '<div style="color: #58a6ff; text-align: center; font-style: italic; padding: 40px; border: 1px dashed #58a6ff; border-radius: 8px;">No performance data available yet. Complete some tests to see your progress.</div>';
      }
      {% endif %}
    }

    // Function to create student trend chart with filtered data
    function createStudentTrendChart(ctxElement, studentTrendData, viewType) {
      // Filter data based on view type
      let filteredData = { ...studentTrendData };
      
      if (viewType === 'recent' && studentTrendData.labels.length > 6) {
        const startIndex = studentTrendData.labels.length - 6;
        filteredData = {
          labels: studentTrendData.labels.slice(startIndex),
          actual_marks: studentTrendData.actual_marks.slice(startIndex),
          predicted_marks: studentTrendData.predicted_marks ? 
            studentTrendData.predicted_marks.slice(startIndex) : [],
          dates: studentTrendData.dates ? 
            studentTrendData.dates.slice(startIndex) : [],
          attendance: studentTrendData.attendance ? 
            studentTrendData.attendance.slice(startIndex) : []
        };
      } else if (viewType === 'semester') {
        // Filter by current semester (this would need server-side implementation)
        // For now, we'll just show all data
        console.log('Semester filter would be implemented server-side');
      }
      
      // Build datasets array safely
      const datasets = [];
      
      // Add actual marks dataset
      datasets.push({
        label: 'Actual Marks',
        data: filteredData.actual_marks,
        borderColor: '#00ffff',
        backgroundColor: 'rgba(0,255,255,0.1)',
        fill: true,
        tension: 0.3,
        borderWidth: 2
      });
      
      // Add predicted marks dataset if available and valid
      const hasPredictedMarks = filteredData.predicted_marks && 
                               Array.isArray(filteredData.predicted_marks) && 
                               filteredData.predicted_marks.length > 0;
      
      if (hasPredictedMarks) {
        datasets.push({
          label: 'Predicted Marks',
          data: filteredData.predicted_marks,
          borderColor: '#58a6ff',
          backgroundColor: 'rgba(88,166,255,0.1)',
          fill: true,
          tension: 0.3,
          borderWidth: 2,
          borderDash: [5, 5]
        });
      }
      
      // Add trend line for performance improvement
      if (filteredData.actual_marks.length > 1) {
        const trendData = calculateTrendLine(filteredData.actual_marks);
        datasets.push({
          label: 'Trend Line',
          data: trendData,
          borderColor: '#00ff99',
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: 0,
          borderDash: [3, 3]
        });
      }
      
      // Destroy existing chart if it exists
      if (ctxElement.chart) {
        ctxElement.chart.destroy();
      }
      
      // Create the chart
      ctxElement.chart = new Chart(ctxElement, {
        type: 'line',
        data: {
          labels: filteredData.labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { 
                color: '#00ffff',
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#00ffff',
              bodyColor: '#ffffff',
              callbacks: {
                afterBody: function(context) {
                  if (context[0].datasetIndex === 0 && context[0].dataIndex > 0) {
                    const current = filteredData.actual_marks[context[0].dataIndex];
                    const previous = filteredData.actual_marks[context[0].dataIndex - 1];
                    const difference = current - previous;
                    const sign = difference > 0 ? '+' : '';
                    return `Change from previous: ${sign}${difference.toFixed(1)}%`;
                  }
                  return '';
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(0, 255, 255, 0.1)'
              },
              ticks: { 
                color: '#00ffff',
                maxRotation: 45
              }
            },
            y: {
              grid: {
                color: 'rgba(0, 255, 255, 0.1)'
              },
              ticks: { 
                color: '#58a6ff',
                stepSize: 10
              },
              beginAtZero: true,
              max: 100,
              min: 0
            }
          }
        }
      });
    }

    // Function to calculate trend line for performance
    function calculateTrendLine(data) {
      if (data.length < 2) return data;
      
      const n = data.length;
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      
      for (let i = 0; i < n; i++) {
        sumX += i;
        sumY += data[i];
        sumXY += i * data[i];
        sumX2 += i * i;
      }
      
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      
      const trendData = [];
      for (let i = 0; i < n; i++) {
        trendData.push(intercept + slope * i);
      }
      
      return trendData;
    }

    // Function to toggle chart view
    function toggleChartView(viewType) {
      currentChartView = viewType;
      
      // Update toggle buttons
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Recreate chart with filtered data
      {% if role == 'Student' and student_info %}
      const studentTrendData = {{ student_chart_json | tojson | safe if student_chart_json is defined else '{"labels": [], "actual_marks": [], "predicted_marks": []}' }};
      const trendCtx = document.getElementById('studentTrendChart');
      
      if (trendCtx && studentTrendData.labels && studentTrendData.labels.length > 0) {
        createStudentTrendChart(trendCtx, studentTrendData, viewType);
      }
      {% endif %}
    }

    // ---------------- Simple Table Sorting ----------------
    function initializeTableSorting() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.style.cursor = 'pointer';
        th.title = 'Click to sort';
        
        th.addEventListener('click', function() {
          const table = this.closest('table');
          if (!table) {
            console.error('Table not found for sorting');
            return;
          }
          
          const tbody = table.querySelector('tbody');
          if (!tbody) {
            console.error('Table body not found for sorting');
            return;
          }
          
          // Get all visible rows (not hidden by search)
          const allRows = Array.from(tbody.querySelectorAll('tr'));
          const rows = allRows.filter(row => 
            !row.style.display || row.style.display === '' || row.style.display === 'none'
          );
          
          if (rows.length === 0) {
            console.log('No rows to sort');
            return;
          }
          
          const colIndex = Array.from(this.parentNode.children).indexOf(this);
          const sortType = this.getAttribute('data-sort');
          
          // Sort rows
          const sortedRows = rows.sort((a, b) => {
            let aVal = a.children[colIndex]?.textContent?.trim() || '';
            let bVal = b.children[colIndex]?.textContent?.trim() || '';
            
            if (sortType === 'number') {
              aVal = parseFloat(aVal) || 0;
              bVal = parseFloat(bVal) || 0;
              return aVal - bVal;
            } else if (sortType === 'date') {
              aVal = new Date(aVal);
              bVal = new Date(bVal);
              return aVal - bVal;
            } else {
              return aVal.localeCompare(bVal);
            }
          });
          
          // Reverse if already sorted ascending
          if (this.classList.contains('sorted-asc')) {
            sortedRows.reverse();
            this.classList.remove('sorted-asc');
            this.classList.add('sorted-desc');
          } else {
            this.classList.remove('sorted-desc');
            this.classList.add('sorted-asc');
          }
          
          // Clear other sort indicators
          table.querySelectorAll('th[data-sort]').forEach(header => {
            if (header !== this) {
              header.classList.remove('sorted-asc', 'sorted-desc');
            }
          });
          
          // Reappend sorted rows
          sortedRows.forEach(row => tbody.appendChild(row));
        });
      });
    }

    // ---------------- Table Search Function ----------------
    function initializeTableSearch() {
      const searchInputs = document.querySelectorAll('.table-search');
      
      searchInputs.forEach(input => {
        input.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const table = this.closest('.table-container')?.querySelector('table') || document.getElementById('studentsTable');
          const rows = table.querySelectorAll('tbody tr');
          
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const isVisibleByFilter = !row.style.display || row.style.display === '';
            row.style.display = text.includes(searchTerm) && isVisibleByFilter ? '' : 'none';
          });
        });
      });
    }

    // ---------------- Initialize Dashboard ----------------
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard initializing...');
      
      // Initialize table functionality
      try {
        initializeTableSearch();
        initializeTableSorting();
      } catch (error) {
        console.error('Error initializing table functions:', error);
      }
      
      // Initialize student trend chart
      try {
        initializeStudentTrendChart();
      } catch (error) {
        console.error('Error initializing student chart:', error);
      }
      
      // Initialize filters and charts for Admin/Teacher
      {% if role in ['Teacher','Admin'] %}
      // Use setTimeout to ensure DOM is fully loaded
      setTimeout(() => {
        try {
          if (typeof updateStatistics === 'function') {
            updateStatistics();
          } else {
            console.warn('updateStatistics function not found');
          }
        } catch (e) {
          console.error('Error in updateStatistics:', e);
        }
        
        try {
          if (typeof updateAllCharts === 'function') {
            updateAllCharts();
          } else {
            console.warn('updateAllCharts function not found');
          }
        } catch (e) {
          console.error('Error in updateAllCharts:', e);
        }
      }, 500); // Increased timeout for better DOM readiness
      {% endif %}
      
      console.log('Dashboard initialization complete');
    });
  </script>
</body>
</html>