<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Student Data - SPAS</title>

  <style>
    :root {
      --bg-color: #0d1117;
      --card-bg: #161b22;
      --text-color: #c9d1d9;
      --accent: #00ffff;          /* BLUE NEON */
      --secondary: #58a6ff;
      --border: #30363d;
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: "Poppins", Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background: var(--card-bg);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 12px var(--accent);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    h1 {
      color: var(--accent);
      margin: 0;
      font-size: 22px;
      text-shadow: 0 0 8px var(--accent);
    }

    .logout {
      color: var(--accent);
      border: 1px solid var(--accent);
      padding: 8px 14px;
      border-radius: 6px;
      text-decoration: none;
      transition: 0.3s;
      box-shadow: 0 0 8px var(--accent);
    }

    .logout:hover {
      background: var(--accent);
      color: var(--bg-color);
      box-shadow: 0 0 15px var(--accent);
    }

    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 25px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 0 25px var(--accent);
    }

    h2 {
      color: var(--accent);
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 10px var(--accent);
    }

    .upload-zone {
      border: 2px dashed var(--accent);
      padding: 50px;
      text-align: center;
      border-radius: 10px;
      background: rgba(0, 255, 255, 0.05);
      transition: 0.3s;
      cursor: pointer;
      box-shadow: 0 0 12px var(--accent);
    }

    .upload-zone.dragover {
      background: rgba(0, 255, 255, 0.15);
      box-shadow: 0 0 25px var(--accent);
    }

    .upload-zone input {
      display: none;
    }

    .upload-zone p {
      margin: 10px 0;
      color: var(--text-color);
    }

    .upload-btn, .import-btn {
      background: var(--accent);
      color: var(--bg-color);
      border: none;
      padding: 10px 22px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 20px;
      box-shadow: 0 0 10px var(--accent);
    }

    .upload-btn:hover, .import-btn:hover {
      box-shadow: 0 0 20px var(--accent);
      transform: scale(1.05);
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
      border: 1px solid var(--border);
      background: var(--card-bg);
    }

    .preview-table th,
    .preview-table td {
      border: 1px solid var(--border);
      padding: 10px;
      text-align: left;
      color: var(--text-color);
    }

    .preview-table th {
      background: var(--bg-color);
      color: var(--accent);
      text-shadow: 0 0 5px var(--accent);
    }

    tr:hover {
      background: rgba(0, 255, 255, 0.1);
    }

    #flashPopup {
      position: fixed;
      top: 25px;
      right: 25px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
    }

    .flash-msg {
      padding: 12px 18px;
      border-radius: 8px;
      color: var(--accent);
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid var(--accent);
      box-shadow: 0 0 15px var(--accent);
      animation: fadeInOut 4s ease forwards;
    }

    .flash-msg.success { border-color: #00ff99; color: #00ff99; }
    .flash-msg.danger { border-color: #ff4d4d; color: #ff4d4d; }
    .flash-msg.warning { border-color: #ffaa00; color: #ffaa00; }

    @keyframes fadeInOut {
      0% {opacity: 0; transform: translateY(-10px);}
      10%, 90% {opacity: 1; transform: translateY(0);}
      100% {opacity: 0; transform: translateY(-10px);}
    }

    .file-info {
      margin: 15px 0;
      padding: 10px;
      background: rgba(0, 255, 255, 0.05);
      border-radius: 6px;
      border: 1px solid var(--accent);
    }

    .error-box {
      color: #ff4d4d;
      background: rgba(255, 77, 77, 0.1);
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      border: 1px solid #ff4d4d;
    }
  </style>
</head>

<body>
  <header>
    <h1>Upload Student Data</h1>
    <a href="{{ url_for('dashboard') }}" class="logout">‚Üê Back to Dashboard</a>
  </header>

  <div class="container">
    <h2>üì§ Upload Student Performance Files</h2>

    <form method="POST" enctype="multipart/form-data" id="uploadForm">
      <div class="upload-zone" id="uploadZone">
        <input type="file" name="files" id="fileInput" accept=".csv,.xlsx,.xls,.json" multiple />
        <p>üìÅ Drag & Drop files here or click to browse.</p>
        <p><small>Allowed: CSV, Excel, JSON</small></p>
        <p><strong>Required columns:</strong> enrollment_no, name, department, college, semester, subject, marks, attendance</p>
      </div>

      <div style="text-align:center;">
        <button type="submit" class="upload-btn">Upload / Import Files</button>
      </div>
    </form>

    <!-- File Previews -->
    <div id="previewContainer">
      {% if previews %}
        {% for preview in previews %}
          <div class="file-info">
            <h3>üìÑ {{ preview.filename }} ({{ preview.rows }} rows)</h3>
            {% if preview.error %}
              <div class="error-box">‚ùå Error: {{ preview.error }}</div>
            {% else %}
              {{ preview.head_html | safe }}
            {% endif %}
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div id="flashPopup">
        {% for category, message in messages %}
          <div class="flash-msg {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <script>
    const uploadZone = document.getElementById("uploadZone");
    const fileInput = document.getElementById("fileInput");
    const previewContainer = document.getElementById("previewContainer");
    let selectedFiles = [];

    uploadZone.addEventListener("click", () => fileInput.click());

    uploadZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadZone.classList.add("dragover");
    });

    uploadZone.addEventListener("dragleave", () => {
      uploadZone.classList.remove("dragover");
    });

    uploadZone.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadZone.classList.remove("dragover");
      selectedFiles = Array.from(e.dataTransfer.files);
      showPreviews();
    });

    fileInput.addEventListener("change", () => {
      selectedFiles = Array.from(fileInput.files);
      showPreviews();
    });

    function showPreviews() {
      previewContainer.innerHTML = "";
      selectedFiles.forEach(file => {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === "csv") previewCSV(file);
        else if (["xlsx","xls"].includes(ext)) previewContainer.innerHTML += `<h3>üìò ${file.name} - Excel file selected (Preview not supported)</h3>`;
        else if (ext === "json") previewJSON(file);
        else alert("Unsupported file type: " + file.name);
      });
    }

    function previewCSV(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const rows = e.target.result.split("\n").map(r => r.split(","));
        let html = "<table class='preview-table'><thead><tr>";
        rows[0].forEach(col => html += `<th>${col.trim()}</th>`);
        html += "</tr></thead><tbody>";
        rows.slice(1, 6).forEach(r => {
          html += "<tr>";
          r.forEach(c => html += `<td>${c.trim()}</td>`);
          html += "</tr>";
        });
        html += "</tbody></table>";
        previewContainer.innerHTML += `<div class="file-info"><h3>üìÑ ${file.name} - CSV Preview (first 5 rows):</h3>${html}</div>`;
      };
      reader.readAsText(file);
    }

    function previewJSON(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const json = JSON.parse(e.target.result);
        previewContainer.innerHTML += `<div class="file-info"><h3>üìÑ ${file.name} - JSON Preview:</h3><pre style='color:var(--accent);'>${JSON.stringify(json,null,2)}</pre></div>`;
      };
      reader.readAsText(file);
    }

    // Remove the fetch submission and use normal form submission
    // The form will handle the file upload normally

    setTimeout(() => { 
      const flashPopup = document.getElementById('flashPopup');
      if (flashPopup) {
        setTimeout(() => flashPopup.remove(), 4500);
      }
    }, 100);
  </script>
</body>
</html>